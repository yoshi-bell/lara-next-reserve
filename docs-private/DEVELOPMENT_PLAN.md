# Rese 開発計画書 (改訂版)

## 0. ドキュメント運用方針 (Meta Rules for AI Agent)

本計画書は、AIエージェントと人間が協働し、コンテキストを維持し続けるための「唯一の正解ソース（Single Source of Truth）」である。AIエージェントは以下の構造的意図を理解し、行動すること。

* **静的ルール (Static Rules):**
    * 「設計概念」「重要事項」「ガイドライン」は、**プロジェクトの憲法**である。これらは常に遵守し、勝手に変更してはならない制約条件として扱うこと。
* **動的タスク (Dynamic Checklists):**
    * 「ロードマップ」や「プロセス記録」は、**実行可能な命令セット**である。これらは単なる読み物ではなく、一つずつ実行し、チェックを入れることで進捗を管理する対象として扱うこと。
* **同期の義務:**
    * 実装とドキュメント（この計画書および `DEV_LOG.md`）に乖離が発生した場合、**必ずドキュメントを正**としてコードを修正するか、あるいはドキュメントを更新してから実装を進めること。

---

## 1. 設計概念 (Core Concepts)

### アーキテクチャ
*   **完全分離構成:** フロントエンド (Next.js) と バックエンド (Laravel API) を疎結合にする。
*   **ステートフル認証:** SPA認証には **Laravel Sanctum (手動設定)** と **NextAuth.js** を採用する。

### 開発方針
*   **機能優先 (Function First):** UIの装飾よりも、データの正確な流れと機能の実装を最優先する。
*   **画面逆算設計 (UI-Driven API):** APIのエンドポイントやレスポンス構造は、画面に必要なデータから逆算して決定する。
*   **堅牢性:** データベースレベルでの制約（複合ユニークキー等）を活用し、データの整合性を担保する。

---

## 2. 重要事項 (Critical Points)

### データベース
*   **複合ユニーク制約:** `reservations` テーブルの `(user_id, start_at)` および `favorites` テーブルの `(user_id, shop_id)` には必ず設定する。
*   **論理削除:** 予約キャンセルは `deleted_at` (SoftDeletes) を使用し、履歴を残す。

### バリデーション
*   **重複予約防止:** DBのユニーク制約に加え、FormRequestクラスで「時間の重複（開始〜終了時間が被る予約）」をチェックするロジックを実装する。

### 非同期処理
*   **リアルタイム性:** 検索フォーム、お気に入り登録、予約空席確認は、画面遷移を伴わない非同期通信 (**SWR** / Axios) で実装する。

### 動作確認ルール (Verification Standards)
ロードマップの各タスクを「完了」とする前に、**必ず** 以下の検証を行い、正常動作を確証すること。AIエージェントは「コードを書いた」だけでなく「動くことを確認した」状態を以てタスク完了とみなす。

* **バックエンド (API):**
    * **レスポンス確認:** cURLやPostman等のツール（またはフロントエンドからの呼び出し）で、想定通りのJSON構造とHTTPステータス(200/201/422等)が返るか。
    * **データ整合性:** APIの返り値だけでなく、**DBの中身**（phpMyAdmin, SQL, Tinker等）を直接確認し、データが正しく保存・更新されているか。
* **フロントエンド (UI):**
    * **コンソール確認:** ブラウザの開発者ツール (F12) を開き、JavaScriptエラー（赤字）や不要な警告が出ていないか。
    * **ネットワーク通信:** Networkタブを確認し、リクエストのペイロード（送信データ）とレスポンスに間違いがないか。
* **エラーハンドリング:**
    * 「成功パターン」だけでなく、わざと不正なデータを送るなどの「失敗パターン」でもアプリがクラッシュしないか。
### プロセス記録ルール (Mandatory)

Git push を実行する直前に、**必ず** 以下の手順をステップ・バイ・ステップで実行し、その結果を出力してください。

#### ステップ 1: 開発ログの記録
* **対象ファイル:** `docs-private/DEV_LOG.md`
* **アクション:** 今回の実装内容を追記する。
* **必須項目:**
    * [ ] 実装した機能の範囲
    * [ ] 採用した技術的判断とその理由（Why）
    * [ ] 発生したエラーとその解決策
    * [ ] 実行した主要コマンド

#### ステップ 2: 復旧マニュアルの整合性確認
* **対象ファイル:** `AGENT_RECOVERY_MANUAL.md`
* **アクション:** `DEV_LOG.md` の更新内容に基づき、マニュアルを最新化する。
* **チェックポイント:**
    * [ ] 「現在の状況・結論」は最新か？（古い情報のままではないか）
    * [ ] 「次のタスク」は更新されているか？

---
**※ AIへの指示:**
このプロセスは、君自身のメモリ（コンテキスト）がリセットされた際に、君自身が迅速に復旧するための生命線です。「形式的な更新」ではなく、「未来の君が読んで完全に理解できる内容」を記述してください。

### Git運用ルール
*   **ドキュメント管理:**
    *   開発中の設計資料（CSV, 開発計画書）やこの開発ログは `docs-private/` に配置。バックアップしておく
    *   開発完了後は`.gitignore` に追加し、リモートリポジトリには公開しない運用とする。その際にGoogleドライブにパックアップ機能を移設
*   **コミット:**
    *   日本語のプレフィックス付きメッセージ（例: `feat:`, `docs:`）でコミットする。

---

## 3. ロードマップ (Roadmap & Execution Checklists)

AIエージェントは、各Phaseの実装を開始する際、以下のチェックリストに従って作業を進めてください。各項目の完了時には「チェック」を入れ、未完了のまま次へ進まないこと。

### Phase 1: 基盤構築と設計 (完了)
* [x] プロジェクト作成 (Laravel + Next.js)
* [x] データベース設計・機能要件定義
* [x] Gitリポジトリ初期化

### Phase 2: データベースとモデル定義 (完了)
* [x] マイグレーションファイルの作成・実行
* [x] モデル・リレーション定義
* [x] 初期データ投入 (Seeder)

### Phase 3: 店舗機能APIの実装 (完了)
* [x] `ShopController` 作成 (`index`, `show` メソッド)
* [x] `GET /api/shops` 実装 (エリア、ジャンル、キーワード検索対応)
* [x] `GET /api/shops/{id}` 実装

### Phase 4: 認証機能の実装 (フロントエンド完了、バックエンド一部未了)
**目標:** Laravel Sanctum と NextAuth.js を連携させ、堅牢なステートフル認証を確立する。

#### ステップ 4-1: バックエンド (Laravel) 実装
* [x] **Sanctum導入:** `laravel/sanctum` のインストールと設定ファイルの公開。
* [x] **ミドルウェア設定:** `bootstrap/app.php` に `EnsureFrontendRequestsAreStateful` を追加。
* [x] **環境変数設定:** `.env` に `SANCTUM_STATEFUL_DOMAINS` を設定。
* [x] **ルート実装 (ログイン/ユーザー取得):**
    * `routes/web.php`: SPA用のログイン (`/login`)・ログアウト (`/logout`) エンドポイント。
    * `routes/api.php`: 認証ユーザー取得用 (`/user`) エンドポイント。
* [x] **ルート実装 (新規登録):**
    * `routes/web.php` または `api.php`: 新規登録 (`/register`) エンドポイント。

#### ステップ 4-2: フロントエンド (Next.js) 実装
* [x] **NextAuth導入:** パッケージインストールと環境変数 (`NEXTAUTH_SECRET`, `BACKEND_URL`) 設定。
* [x] **Provider実装:** `app/api/auth/[...nextauth]/route.ts` に `CredentialsProvider` を作成。
* [x] **型定義拡張:** `types/next-auth.d.ts` で `Session` と `User` の型を拡張。
* [x] **Context設定:** `app/providers.tsx` を作成し、`layout.tsx` 全体をラップ。
* [x] **画面実装:**
    * `/login`: ログインフォームコンポーネント作成。
    * `/register`: 新規登録フォームコンポーネント作成。

### Phase 5: フロントエンドの実装 (店舗・予約・お気に入り)
**目標:** APIから取得したデータを用いて、店舗一覧、詳細、予約、お気に入り機能を画面に実装する。

#### ステップ 5-1: 店舗機能
* [ ] **データ取得:** SWR (`useSWR`) を用いたデータフェッチ用のカスタムフックを実装する。
* [ ] **店舗一覧ページ:**
    * [ ] 全店舗をカード形式で表示する。
    * [ ] 店舗の画像、名前、エリア、ジャンルを表示する。
    * [ ] (要ログイン) お気に入り状態をハートアイコンで表示する。
* [ ] **検索機能:**
    * [ ] エリア、ジャンル、キーワードによる絞り込みUIを実装する。
    * [ ] 検索条件の変更に応じて、店舗一覧を非同期で更新する。
* [ ] **店舗詳細ページ:**
    * [ ] 選択した店舗の詳細情報を表示する。
    * [ ] 予約フォームコンポーネントを表示する。

#### ステップ 5-2: 予約・お気に入り機能 (要ログイン)
* [ ] **お気に入り機能:**
    * [ ] ハートアイコンクリックで、お気に入りの登録/解除を行うAPIをコールする。
    * [ ] 画面遷移なしで表示を更新する。
* [ ] **予約機能:**
    * [ ] 日付、時間、人数を選択するUIを実装する。
    * [ ] 選択内容に応じて、予約APIをコールする。
    * [ ] 予約完了後、完了ページ (`/done`) に遷移させる。
* [ ] **マイページ:**
    * [ ] 予約状況一覧コンポーネントを実装する。
    * [ ] 予約キャンセルボタンと機能を実装する。
    * [ ] お気に入り店舗一覧コンポーネントを実装する。

### Phase 6: 仕上げと拡張
* [ ] **メール送信:**
    * [ ] 新規登録完了メール。
    * [ ] 予約完了メール。
    * [ ] (バッチ処理) 予約リマインダーメール。
* [ ] **ドキュメント整備:** READMEに必要な情報を追記する。
* [ ] **デプロイ準備:** 本番環境へのデプロイ手順を確立する。

---

## 4. フロントエンド実装ガイドライン (Tailwind CSS)

### 基本方針
*   **モバイルファースト (Mobile First):**
    *   基本スタイルはスマホ（最小画面）向けに記述する。
    *   PC向けのスタイルは `md:`, `lg:` などのプレフィックスを用いて上書きする。

### スタイリングルール
*   **ユーティリティファースト:**
    *   CSSファイルへの記述は避け、JSX内の `className` に直接記述する。
    *   `@apply` の使用は原則禁止し、再利用が必要な場合は **Reactコンポーネント化** で対応する。
*   **自動整形:**
    *   `prettier-plugin-tailwindcss` を導入し、クラス名の並び順を自動で統一する。
