# lara-next-reserve 開発ログ (Development Log)

## 概要
このドキュメントは、「lara-next-reserve（飲食店予約サービス）」の開発プロセス、技術的決定事項、および学習の軌跡を記録するものです。

---

## 2026-01-13: プロジェクト開始と初期設計

### 1. プロジェクトの目的と方針
*   **目的:** LaravelとNext.jsを用いた実践的なWebアプリケーション開発を通じて、モダンな開発フローを学習する。
*   **基本方針:**
    *   **フロントエンド(FE)とバックエンド(BE)の完全分離:** 疎結合なアーキテクチャを採用。
    *   **機能優先:** UIの装飾よりも、データの流れと機能の実装を最優先する。
    *   **画面逆算設計:** APIの仕様は、画面に必要なデータから逆算して決定する。

### 2. 環境構築
*   **ディレクトリ構成:**
    *   `laravel-next-app`: バックエンド (Laravel 12 + Sail)
    *   `next-frontend-app`: フロントエンド (Next.js App Router + Tailwind CSS)
    *   これらを `lara-next-reserve` ルートディレクトリ直下に並列配置（モノレポ構成）。
*   **構築手順:**
    1.  `curl` コマンドで Laravel Sail プロジェクトを作成。
    2.  `create-next-app` で Next.js プロジェクトを作成（TypeScript, ESLint, Tailwind 採用）。
    3.  `.git` フォルダを整理し、ルートディレクトリで一括管理するよう初期化。

### 3. 設計プロセス（要件定義〜DB設計）
*   **要件の洗い出し:**
    *   Googleスプレッドシート（要件定義書）の分析。
    *   コーチ要件（電話番号追加、予約制限など）の統合。
    *   UI画像（`yoyaku_ui`）の分析による、予約キャンセル機能やお気に入り機能の具体化。
*   **データベース設計の決定事項:**
    *   **Users:** 電話番号、性別、年齢カラムを追加。
    *   **Shops:** 予約制御用カラム（開始・終了時間、収容人数）を追加。
    *   **Reservations:**
        *   キャンセル機能のため、論理削除（`deleted_at`）を採用。
        *   **複合ユニーク制約:** `(user_id, date, time)` で同一ユーザーの同時間帯の重複登録を物理的に防止。
    *   **Favorites:** 中間テーブルを作成し、`(user_id, shop_id)` に複合ユニーク制約を設定。

---

## 2026-01-16: Phase 2「データベースとモデル定義」完了

### 1. 完了したタスク
*   **マイグレーションファイルの作成とデータベース構築:**
    *   すべての計画されたテーブル（`users`, `shops`, `areas`, `genres`, `reservation_slots`, `reservations`, `favorites`）に対応するマイグレーションファイルが作成されました。
    *   `sail artisan migrate` によりデータベースが構築され、スキーマが適用済みです。
*   **モデル・リレーションの実装:**
    *   すべてのテーブルに対応するEloquentモデル（`User`, `Shop`, `Reservation`など）が作成されました。
    *   各モデルにおいて、設計書に基づいたリレーション（`hasMany`, `belongsTo`など）が適切に定義されています。

### 2. 特記事項
*   **複合ユニーク制約の確認:**
    *   `reservations`テーブルの `(user_id, start_at)` および `favorites`テーブルの `(user_id, shop_id)` において、複合ユニーク制約がマイグレーションファイルに正しく実装されていることを確認しました。これにより、データベースレベルでの重複登録が防止されます。
*   **論理削除 (SoftDeletes):**
    *   `reservations`テーブルにおいて、予約キャンセル機能のために `SoftDeletes` が適切に導入されていることを確認しました。
*   **拡張カラムの確認:**
    *   `users`テーブルの `phone_number`, `gender`, `birthday` や `shops`テーブルの `start_time`, `end_time`, `default_capacity`, `default_stay_time` といった追加要件のフィールドがモデルの`$fillable`属性に含まれており、適切に扱われる準備ができています。

### 3. 次のステップ
*   開発計画書「DEVELOPMENT_PLAN_revised.md」に基づき、Phase 3「店舗機能APIの実装」を開始します。

---

## 2026-01-16: Phase 3「店舗機能APIの実装」完了

### 1. 完了したタスク
*   **`ShopController` の実装:**
    *   `index` メソッド（店舗一覧取得・検索フィルタ対応）および `show` メソッド（店舗詳細取得）が、開発計画の要件通りに実装されました。Eager Loadingやルートモデルバインディングなど、Laravelのベストプラクティスが適用されています。
*   **APIルートの定義:**
    *   `routes/api.php` に `GET /api/shops` および `GET /api/shops/{shop}` ルートが正しく定義され、`ShopController` の各メソッドに紐付けられました。

---

## 2026-01-16: Phase 4「認証機能の実装」フロントエンド側の基本設定完了

### 1. 完了したタスク

#### バックエンド (Laravel)
*   **Sanctum SPA認証の有効化:**
    *   Laravel 11の仕様に合わせ、`bootstrap/app.php` に `EnsureFrontendRequestsAreStateful` ミドルウェアを登録しました。
    *   `.env` ファイルに `SANCTUM_STATEFUL_DOMAINS=localhost:3000` を設定し、フロントエンドからのステートフルなリクエストを許可しました。

#### フロントエンド (Next.js)
*   **`next-auth` の導入:**
    *   `next-auth` パッケージをインストールしました。
    *   ログイン・登録ページの作成（後に Axios 方式にリファクタリング）。

---

## 2026-01-18: Phase 4「認証機能の実装」結合テストおよび問題解決

### 1. 問題解決の経緯
*   **NextAuth廃止:** Sanctum (Cookieベース認証) との相性問題（CSRF保護等）を解決するため、NextAuthを廃止し、Axios + SWR による手動実装に切り替え。
*   **CSRF/CORS対策:** `config/cors.php` や Axios インターセプターを調整し、ステートフル認証を確立。

---

## 2026-01-19: Phase 5「フロントエンドの実装」完了

### 1. 完了したタスク
*   店舗一覧、検索、詳細、お気に入り、予約、マイページの各画面およびロジックを実装。
*   **在庫管理ロジック:** 30分刻みのスロット管理（`ReservationSlot`）と、トランザクションによる排他制御（ダブルブッキング防止）を実装。

---

## 2026-01-26: Phase 6「仕上げと拡張」および品質強化リファクタリング

### 1. 完了したタスク

#### 機能拡張とドキュメント
*   **予約リマインダー:** Artisanコマンドとスケジューラによる来店前日メール送信機能を実装。
*   **README.md / 基本設計書:** 実装内容と完全に同期させたドキュメント一式を作成。

#### バックエンドのリファクタリング
*   **コントローラー分離:** `routes/api.php` の巨大なクロージャを `AuthenticatedSessionController` と `UserController` に分離。
*   **FormRequestの導入:** 全てのバリデーションを専用クラスに集約。
    *   **日本語化:** `messages()` / `attributes()` による丁寧な日本語エラーメッセージの実装。
    *   **重複予約防止:** `StoreReservationRequest` 内で、同一ユーザーの同時間帯予約をチェックするカスタムルールを追加し、APIレベルでの整合性チェックを強化。
*   **システム全体日本語化:** 
    *   `laravel-lang/common` パッケージを導入し、標準メッセージを日本語化。
    *   `AppServiceProvider` で `App::setLocale('ja')` を強制。
    *   `bootstrap/app.php` で `AuthenticationException` をオーバーライドし、ハードコードされた英語メッセージ「Unauthenticated.」を「認証されていません。」に解決。

#### フロントエンドの改善
*   **コンポーネント分離:** `ReservationForm.tsx` を切り出し、詳細ページの責務を分離。
*   **UI調整:** ログイン・登録画面を仕様（青ヘッダー）に合わせて修正。
*   **UX向上:** マイページでのお気に入り解除時に確認ダイアログを追加し、誤操作を防止。さらに「お気に入り解除時の確認を省略」設定をLocalStorageで管理する機能を実装。
    *   実装にあたり、ESLint (`set-state-in-effect`) との衝突を `setTimeout` による非同期化で解決。
*   **開発効率化:** フォームに `noValidate` を追加し、バックエンドバリデーションを直接検証可能な環境を構築。

#### 品質保証 (Testing)
*   **網羅的テストの実装:** `AuthenticationTest`, `RegistrationTest`, `ReservationTest`, `ShopTest`, `MyPageTest` を実装。
    *   リファクタリング前後でのテスト実行により、デグレード（機能劣化）がないことを証明。
    *   ファクトリ (`ReservationFactory`) を修正し、追加された `usage_time` カラムに対応。
*   **データのリアル化:** `ShopSeeder` を修正し、店舗ごとに異なる営業時間・収容人数を設定。より現実に即したテストデータ環境を構築。

### 2. 学習・技術的判断
*   **根本解決 vs 対症療法:** 認証メッセージの日本語化において、翻訳ファイルやロケール強制でも解決しない「フレームワークのハードコード」という壁に直面し、最終的に例外ハンドラーのオーバーライドを選択。技術的な限界と実利的な解決のバランスを学んだ。
*   **テスト駆動の安心感:** 構造を大きく変えるリファクタリングにおいて、テストが「緑」であることの心理的・技術的な安全性を再確認した。
*   **UXと設計のトレードオフ:** 「毎回確認」の煩わしさと「誤操作」のリスクを考慮し、LocalStorageを活用した設定機能と、Propsの論理統合（showConfirmDialog）によるクリーンなコンポーネント設計を実践。

### 3. 次のステップ
*   プロジェクト継続。さらなる機能拡張や改善を検討。

---

## 2026-01-27: マイページ機能拡張と最終調整

### 1. 完了したタスク

#### 予約履歴・ナビゲーション機能
*   **予約履歴機能:** APIのクエリ拡張 (`?type=history`) とフロントエンドのタブUI、再予約導線を実装。
*   **ヘッダー改善:** ユーザー名横に「マイページ」ラベルを追加。ログイン・登録画面にもヘッダーを配置し、トップページへの導線を確保。
*   **ハンバーガーメニュー:** 全画面オーバーレイ形式のメニュー (`MenuOverlay`) を実装し、フェードインアニメーションを適用。
*   **ログイン導線の修正:** SWRキャッシュによるリダイレクトループ問題を解決するため、ログイン成功後に `mutate()` を実行するよう修正。

### 2. プロジェクト完了
これにて予定されていた機能実装、リファクタリング、ドキュメント整備が完了しました。

---

## 2026-01-27: ドキュメント整備とテストカバレッジの完全化

### 1. 完了したタスク

#### 環境構築・ドキュメントの改善
*   **README.md の更新:** 実装済み機能（予約履歴、リマインダー、お気に入り設定）を反映し、セットアップ手順を現在の構成に即して修正。テスト実行コマンドも追記。
*   **環境設定ファイルの整備:** `.env.example` を Docker/Sail 環境で即座に動作するよう更新し、フロントエンド用 `.env.local.example` を新規作成。

#### 品質保証の強化 (Testing)
*   **機能一覧に基づく未実装テストの補完:**
    *   **空席状況判定:** 満席時に予約がエラー (400) になることを検証するテストを追加。
    *   **メール送信検証:** 会員登録完了、および予約完了時に正しい通知・メールが送信されることを `Notification::fake()` / `Mail::fake()` を用いて検証。
    *   **予約リマインダー:** `app:send-reservation-reminders` コマンドの実行により、翌日の予約者にリマインダーメールが送信されることを検証。
*   **クリーンアップ:** デフォルトの `ExampleTest.php` を削除し、テストスイートをプロジェクト固有の機能テストのみに整理。

### 2. プロジェクト全体のリネームとデータ環境の整備



#### プロジェクト名変更 (Rebranding)

*   サービス名を「Rese」から「lara-next-reserve」へ完全に移行。

*   `README.md`、`docs-private/` 内の全ドキュメント、およびメールテンプレート内の名称を統一。



#### データ生成の高度化 (Advanced Seeding)

*   **`ReservationSeeder` の新規実装:** 

    *   各テストユーザーに対し「未来の予約3件」「過去の予約2件」を自動生成するロジックを構築。

    *   **整合性チェック:** ユーザーの既存予約との時間重複回避、および店舗の最大収容人数を超えない在庫管理（`ReservationSlot` との同期）を実装。

    *   **営業時間対応:** 店舗ごとの `start_time` / `end_time` を解析し、営業時間内でのみ予約を生成するよう最適化。



#### アセット管理の改善 (Local Asset Management)

*   **店舗画像のローカル化:** AWS S3 への外部依存を排除するため、画像を `laravel-next-app/public/images/shops/` へダウンロードし、ディレクトリ構造によるリソース管理を導入。

*   **パス管理の変更:** DB（`shops.image_url`）には `/images/shops/xxx.jpg` という相対パスを保存する運用に変更。



#### フロントエンドの画像表示最適化

*   **URL解決:** `ShopCard` および詳細ページにおいて、`NEXT_PUBLIC_BACKEND_URL` とDBの相対パスを結合して表示するよう修正。

*   **Next.js最適化の調整:**

    *   `next.config.ts` で `localhost` からの画像取得を許可。

    *   開発環境でのネットワーク制限（SSRF対策による private IP ブロック）を回避するため、`<Image>` コンポーネントに `unoptimized` プロパティを採用。

*   **UI調整:** 詳細ページの画像コンテナのCSSクラスを見直し、スマホ・PC両方で画像が正しく表示されるよう高さを確保。



### 3. 最終状態の確認

*   バックエンドの全テスト (34 tests, 82 assertions) が PASS し、ロジック変更によるデグレードがないことを確認済み。
