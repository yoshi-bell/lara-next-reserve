# lara-next-reserve 開発ワークフロー (Workflow & Checklists)

## 開発ルール (Rules for Execution)

### 動作確認ルール (Verification Standards)
ロードマップの各タスクを「完了」とする前に、**必ず** 以下の検証を行い、正常動作を確証すること。

* **バックエンド (API):**
    * **レスポンス確認:** cURL等で、想定通りのJSON構造とHTTPステータスが返るか。
    * **データ整合性:** DBの中身を直接確認し、データが正しく保存・更新されているか。
* **フロントエンド (UI):**
    * **コンソール確認:** ブラウザの開発者ツールで、JavaScriptエラーや不要な警告が出ていないか。
    * **ネットワーク通信:** Networkタブで、リクエストとレスポンスに間違いがないか。
* **エラーハンドリング:**
    * 「成功パターン」だけでなく、「失敗パターン」でもアプリがクラッシュしないか。

### プロセス記録ルール (Mandatory)
`git push` を実行する直前に、**必ず** 以下の手順をステップ・バイ・ステップで実行すること。

#### ステップ 1: 開発ログの記録
* **対象ファイル:** `docs-private/DEV_LOG.md`
* **アクション:** 実装内容、技術的判断、エラーと解決策、実行コマンドを追記する。

#### ステップ 2: 復旧マニュアルの整合性確認
* **対象ファイル:** `AGENT_RECOVERY_MANUAL.md`
* **アクション:** `DEV_LOG.md` の更新内容に基づき、マニュアルを最新化する。

#### ステップ 3: Gitコミット
* **言語:** 日本語で記述すること。
* **フォーマット:** `プレフィックス: 内容` の形式とする。
* **使用可能なプレフィックス:**
    * `feat`: 新機能の追加
    * `fix`: バグ修正
    * `docs`: ドキュメントのみの変更
    * `style`: コードの動作に影響しない変更（空白、フォーマットなど）
    * `refactor`: バグ修正も機能追加も行わないコード変更
    * `test`: テストの追加・修正
    * `chore`: ビルドプロセス、ツール、ワークフローの変更

---

## 【現在進行中のタスク】 (Active Context)
> AIエージェントは作業中、常にここを更新すること。

**現在のフェーズ:** Phase 6: 仕上げと拡張
**現在のアクティブタスク:** ステップ 6-3 最終確認 > **デプロイ準備の検討**
**ステータス:** README.mdの作成、テーブル仕様書の同期が完了。プロジェクトの最終仕上げ段階。

---

## 0. ワークフローの目的 (Meta Rules for AI Agent)
本ドキュメントは、「lara-next-reserve」プロジェクトにおける具体的な開発タスクと手順を定義する「唯一の正解ソース（Single Source of Truth）」である。AIエージェントは、タスクを実行する際、必ずこのワークフローに従うこと。

- **役割:** このドキュメントは、プロジェクトの「実行可能な命令セット」である。単なる読み物ではなく、一つずつ実行し、チェックを入れることで進捗を管理する対象として扱うこと。
- **原則:** チェックリストの項目は、必ず上から順に実行すること。未完了のタスクをスキップしてはならない。
- **完了定義:** 各タスクは、「実装」だけでなく、後述する「動作確認」と「プロセス記録」が完了して初めて「完了済み（[x]）」とみなされる。
- **割り込みタスクの扱い (Interrupt Handling):**
    - お客様からの新しいご指示や、予期せぬエラーが発生した場合、それを割り込みタスクとして最優先で扱うこと。
    - その際、まずこのドキュメントの「【現在進行中のタスク】」セクションを更新し、元のタスクを「保留」にして割り込みタスクを記録する。
    - 割り込みタスク完了後、元のタスクを再開すること。

---

## 1. ロードマップ (Roadmap & Execution Checklists)
AIエージェントは、各Phaseの実装を開始する際、以下のチェックリストに従って作業を進めてください。

### Phase 1: 基盤構築と設計 (完了)
* [x] プロジェクト作成 (Laravel + Next.js)
* [x] データベース設計・機能要件定義
* [x] Gitリポジトリ初期化

### Phase 2: データベースとモデル定義 (完了)
* [x] マイグレーションファイルの作成・実行
* [x] モデル・リレーション定義
* [x] 初期データ投入 (Seeder)

### Phase 3: 店舗機能APIの実装 (完了)
* [x] `ShopController` 作成 (`index`, `show` メソッド)
* [x] `GET /api/shops` 実装 (エリア、ジャンル、キーワード検索対応)
* [x] `GET /api/shops/{id}` 実装

### Phase 4: 認証機能の実装 (完了)
**目標:** Laravel Sanctum と Axios を連携させ、堅牢なステートフル認証を確立する。

#### ステップ 4-1: バックエンド (Laravel) 実装
* [x] **Sanctum導入:** `laravel/sanctum` のインストールと設定ファイルの公開。
* [x] **ミドルウェア設定:** `bootstrap/app.php` に `EnsureFrontendRequestsAreStateful` を追加。
* [x] **環境変数設定:** `.env` に `SANCTUM_STATEFUL_DOMAINS` を設定。
* [x] **ルート実装 (ログイン/ユーザー取得):**
    * `routes/web.php`: SPA用のログイン (`/login`)・ログアウト (`/logout`) エンドポイント。
    * `routes/api.php`: 認証ユーザー取得用 (`/user`) エンドポイント。
* [x] **ルート実装 (新規登録):**
    * `routes/api.php`: 新規登録 (`/register`) エンドポイント。
* [x] **リファクタリング:** 認証関連ルートを `/api` プレフィックスに統一。

#### ステップ 4-2: フロントエンド (Next.js) 実装
* [x] **認証基盤実装:** パッケージインストールと `axios` インスタンスの設定。
* [x] **型定義:** `Shop` や `User` の型定義。
* [x] **画面実装:**
    * `/login`: ログインフォームコンポーネント作成。
    * `/register`: 新規登録フォームコンポーネント作成。
* [x] **共通ヘッダー:** `Header.tsx` の実装 e `useAuth` フックによる認証状態表示。

#### ステップ 4-3: 結合テストと問題解決
* [x] **CSRF/CORS問題解決:** `SESSION_DOMAIN`, `SESSION_SECURE_COOKIE` の設定、`config/cors.php` の作成、`axios` インターセプターによる `X-XSRF-TOKEN` ヘッダーの明示的な付与など、一連の問題を解決。
* [x] **結合テスト完了:** 新規登録からログインまでの一連のフローが正常に動作することを確認。

### Phase 5: フロントエンドの実装 (店舗・予約・お気に入り)
**目標:** APIから取得したデータを用いて、店舗一覧、詳細、予約、お気に入り機能を画面に実装する。

#### ステップ 5-1: 店舗機能
- [x] **データ取得用のカスタムフック実装 (`useShops`)**
- [x] **店舗一覧ページのUI構築**
- [x] **検索機能の実装**
- [x] **店舗詳細ページの実装**

#### ステップ 5-2: 予約・お気に入り機能 (要ログイン)
- [x] **お気に入り機能の実装**
- [x] **予約機能の実装**
- [x] **マイページの実装**

### Phase 6: 仕上げと拡張
- [x] **メール機能の実装**
    - [x] **予約完了メール:** Mailable作成、送信ロジック実装。
    - [x] **メール認証機能:** `MustVerifyEmail`実装、認証コントローラー、リダイレクト処理。
    - [x] **予約リマインダー:** Artisanコマンド作成、スケジュール設定、Mailable作成。
    - [x] **動作確認:** Mailpitでの受信確認、認証フローの確認。
    - [x] **プロセス記録:** `DEV_LOG.md`, `AGENT_RECOVERY_MANUAL.md` を更新済み。

- [x] **ドキュメント整備**
    - [x] **実装:**
        - [x] `README.md` に、アプリケーションの概要、セットアップ方法、使用技術などを記述する。
        - [x] テーブル仕様書 (CSV) を実際の実装に合わせて更新。
    - [x] **動作確認:**
        - [x] 記述内容に誤りがないか確認する。
    - [x] **プロセス記録:**
        - [x] `DEV_LOG.md`, `AGENT_RECOVERY_MANUAL.md` を更新する。

- [ ] **デプロイ準備**
    - [ ] **実装:**
        - [ ] 本番環境へのデプロイ手順を確立する。
    - [ ] **動作確認:**
        - [ ] デプロイ手順が正しく動作することを確認する。
    - [ ] **プロセス記録:**
        - [ ] `DEV_LOG.md`, `AGENT_RECOVERY_MANUAL.md` を更新する。