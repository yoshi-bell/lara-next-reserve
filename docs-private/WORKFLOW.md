# Rese 開発ワークフロー (Workflow & Checklists)

## 【現在進行中のタスク】 (Active Context)
> AIエージェントは作業中、常にここを更新すること。

**現在のフェーズ:** Phase 5: フロントエンドの実装 (店舗・予約・お気に入り)
**現在のアクティブタスク:** ステップ 5-1 店舗機能 > **検索機能の実装**
**ステータス:** 「店舗一覧ページのUI構築」が完了し、検索機能の実装準備中。

---

## 0. ワークフローの目的 (Meta Rules for AI Agent)
本ドキュメントは、「Rese」プロジェクトにおける具体的な開発タスクと手順を定義する「唯一の正解ソース（Single Source of Truth）」である。AIエージェントは、タスクを実行する際、必ずこのワークフローに従うこと。

- **役割:** このドキュメントは、プロジェクトの「実行可能な命令セット」である。単なる読み物ではなく、一つずつ実行し、チェックを入れることで進捗を管理する対象として扱うこと。
- **原則:** チェックリストの項目は、必ず上から順に実行すること。未完了のタスクをスキップしてはならない。
- **完了定義:** 各タスクは、「実装」だけでなく、後述する「動作確認」と「プロセス記録」が完了して初めて「完了済み（[x]）」とみなされる。
- **割り込みタスクの扱い (Interrupt Handling):**
    - お客様からの新しいご指示や、予期せぬエラーが発生した場合、それを割り込みタスクとして最優先で扱うこと。
    - その際、まずこのドキュメントの「【現在進行中のタスク】」セクションを更新し、元のタスクを「保留」にして割り込みタスクを記録する。
    - 割り込みタスク完了後、元のタスクを再開すること。

---

## 1. ロードマップ (Roadmap & Execution Checklists)
AIエージェントは、各Phaseの実装を開始する際、以下のチェックリストに従って作業を進めてください。

### Phase 1: 基盤構築と設計 (完了)
* [x] プロジェクト作成 (Laravel + Next.js)
* [x] データベース設計・機能要件定義
* [x] Gitリポジトリ初期化

### Phase 2: データベースとモデル定義 (完了)
* [x] マイグレーションファイルの作成・実行
* [x] モデル・リレーション定義
* [x] 初期データ投入 (Seeder)

### Phase 3: 店舗機能APIの実装 (完了)
* [x] `ShopController` 作成 (`index`, `show` メソッド)
* [x] `GET /api/shops` 実装 (エリア、ジャンル、キーワード検索対応)
* [x] `GET /api/shops/{id}` 実装

### Phase 4: 認証機能の実装 (完了)
**目標:** Laravel Sanctum と NextAuth.js を連携させ、堅牢なステートフル認証を確立する。

#### ステップ 4-1: バックエンド (Laravel) 実装
* [x] **Sanctum導入:** `laravel/sanctum` のインストールと設定ファイルの公開。
* [x] **ミドルウェア設定:** `bootstrap/app.php` に `EnsureFrontendRequestsAreStateful` を追加。
* [x] **環境変数設定:** `.env` に `SANCTUM_STATEFUL_DOMAINS` を設定。
* [x] **ルート実装 (ログイン/ユーザー取得):**
    * `routes/web.php`: SPA用のログイン (`/login`)・ログアウト (`/logout`) エンドポイント。
    * `routes/api.php`: 認証ユーザー取得用 (`/user`) エンドポイント。
* [x] **ルート実装 (新規登録):**
    * `routes/api.php`: 新規登録 (`/register`) エンドポイント。
* [x] **リファクタリング:** 認証関連ルートを `/api` プレフィックスに統一。

#### ステップ 4-2: フロントエンド (Next.js) 実装
* [x] **NextAuth導入:** パッケージインストールと環境変数設定。
* [x] **Provider実装:** `app/api/auth/[...nextauth]/route.ts` に `CredentialsProvider` を作成。
* [x] **型定義拡張:** `types/next-auth.d.ts` で `Session` と `User` の型を拡張。
* [x] **Context設定:** `app/providers.tsx` を作成し、`layout.tsx` 全体をラップ。
* [x] **画面実装:**
    * `/login`: ログインフォームコンポーネント作成。
    * `/register`: 新規登録フォームコンポーネント作成。
* [x] **リファクタリング:** `axios` を導入し、`login` と `register` の通信を統一。

#### ステップ 4-3: 結合テストと問題解決
* [x] **CSRF/CORS問題解決:** `SESSION_DOMAIN`, `SESSION_SECURE_COOKIE` の設定、`config/cors.php` の作成、`axios` インターセプターによる `X-XSRF-TOKEN` ヘッダーの明示的な付与など、一連の問題を解決。
* [x] **バリデーション問題解決:** フロントエンドとバックエンドのキー名の不一致 (`phone` vs `phone_number`) を修正。
* [x] **結合テスト完了:** 新規登録からログインまでの一連のフローが正常に動作することを確認。

### Phase 5: フロントエンドの実装 (店舗・予約・お気に入り)
**目標:** APIから取得したデータを用いて、店舗一覧、詳細、予約、お気に入り機能を画面に実装する。

#### ステップ 5-1: 店舗機能
- [x] **データ取得用のカスタムフック実装 (`useShops`)**
    - [x] **実装:**
        - [x] `swr` をインストールする。
        - [x] `src/hooks/useShops.ts` を作成し、SWRと`axios`を用いて `/api/shops` からデータをフェッチするロジックを実装する。
    - [x] **動作確認:**
        - [x] テスト用のページ (`/shops`) を作成し、フックを呼び出してコンソールにデータが表示されることを確認する。
    - [x] **プロセス記録:**
        - [ ] `DEV_LOG.md`, `AGENT_RECOVERY_MANUAL.md` を更新する。

- [x] **店舗一覧ページのUI構築**
    - [x] **実装:**
        - [x] `shops/page.tsx` で、`useShops` フックを使いデータを取得する。
        - [x] 取得した店舗データをカード形式で表示するUIを構築する（店舗名、画像、エリア名、ジャンル名）。
        - [x] `Area` と `Genre` の名前を表示するため、バックエンドの `ShopController@index` を `with(['area', 'genre'])` でリレーションをEager Loadingするように修正する。
        - [x] `useShops` フックの型定義を、`Area` と `Genre` のリレーションを含むように更新する。
    - [x] **動作確認:**
        - [x] ブラウザで `/shops` にアクセスし、店舗一覧が意図通りに表示されるか確認する。
        - [x] コンソールにエラーが出ていないか確認する。
    - [x] **プロセス記録:**
        - [x] `DEV_LOG.md`, `AGENT_RECOVERY_MANUAL.md` を更新する。

- [ ] **検索機能の実装**
    - [ ] **実装:**
        - [ ] エリア、ジャンル、キーワードによる絞り込みUIを実装する。
        - [ ] 検索条件の変更に応じて、店舗一覧を非同期で更新するロジックを実装する (`useShops` の引数または `mutate` を活用)。
    - [ ] **動作確認:**
        - [ ] 各検索条件で店舗が正しくフィルタリングされることを確認する。
    - [ ] **プロセス記録:**
        - [ ] `DEV_LOG.md`, `AGENT_RECOVERY_MANUAL.md` を更新する。

- [ ] **店舗詳細ページの実装**
    - [ ] **実装:**
        - [ ] `/shops/[id]` のルートを作成する。
        - [ ] 選択した店舗の詳細情報を表示するUIを構築する。
        - [ ] 予約フォームコンポーネントを配置する。
    - [ ] **動作確認:**
        - [ ] 店舗一覧から詳細ページに正しく遷移できることを確認する。
        - [ ] 店舗情報が正しく表示されることを確認する。
    - [ ] **プロセス記録:**
        - [ ] `DEV_LOG.md`, `AGENT_RECOVERY_MANUAL.md` を更新する。


#### ステップ 5-2: 予約・お気に入り機能 (要ログイン)
- [ ] **お気に入り機能の実装**
    - [ ] **バックエンド実装:**
        - [ ] `FavoriteController` を作成し、お気に入りの登録/解除を行う `store`/`destroy` メソッドを実装する。
        - [ ] `routes/api.php` に `/shops/{shop}/favorite` のようなルートを定義する (`auth:sanctum` ミドルウェアで保護)。
    - [ ] **フロントエンド実装:**
        - [ ] ハートアイコンクリックで、`axios` を使ってお気に入り登録/解除APIをコールするロジックを実装する。
        - [ ] 画面遷移なしでハートアイコンの表示状態を更新する。
    - [ ] **動作確認:**
        - [ ] ログイン状態で、お気に入り登録・解除が正しく動作することを確認する。
        - [ ] データベースの `favorites` テーブルにレコードが正しく作成・削除されることを確認する。
    - [ ] **プロセス記録:**
        - [ ] `DEV_LOG.md`, `AGENT_RECOVERY_MANUAL.md` を更新する。

- [ ] **予約機能の実装**
    - [ ] **バックエンド実装:**
        - [ ] `ReservationController` を作成し、予約を作成する `store` メソッドを実装する。
        - [ ] `routes/api.php` に `/reservations` のようなルートを定義する (`auth:sanctum` ミドルウェアで保護)。
    - [ ] **フロントエンド実装:**
        - [ ] 日付、時間、人数を選択するUIを実装する。
        - [ ] 選択内容に応じて、`axios` を使って予約APIをコールするロジックを実装する。
        - [ ] 予約完了後、完了ページ (`/done`) に遷移させる。
    - [ ] **動作確認:**
        - [ ] ログイン状態で、予約が正しく作成されることを確認する。
        - [ ] データベースの `reservations` テーブルにレコードが正しく作成されることを確認する。
    - [ ] **プロセス記録:**
        - [ ] `DEV_LOG.md`, `AGENT_RECOVERY_MANUAL.md` を更新する。

- [ ] **マイページの実装**
    - [ ] **実装:**
        - [ ] `/mypage` のルートを作成する。
        - [ ] ユーザーの予約状況一覧を表示するコンポーネントを実装する。
        - [ ] 予約キャンセルボタンと機能を実装する（バックエンドの`ReservationController@destroy`が必要）。
        - [ ] お気に入り店舗一覧を表示するコンポーネントを実装する。
    - [ ] **動作確認:**
        - [ ] 予約一覧、お気に入り一覧が正しく表示されることを確認する。
        - [ ] 予約キャンセルが正しく動作することを確認する。
    - [ ] **プロセス記録:**
        - [ ] `DEV_LOG.md`, `AGENT_RECOVERY_MANUAL.md` を更新する。

### Phase 6: 仕上げと拡張
- [ ] **メール送信機能の実装**
    - [ ] **実装:**
        - [ ] 新規登録完了メール。
        - [ ] 予約完了メール。
        - [ ] (バッチ処理) 予約リマインダーメール。
    - [ ] **動作確認:**
        - [ ] 各トリガーでメールが正しく送信されることを確認する（Mailpit等で確認）。
    - [ ] **プロセス記録:**
        - [ ] `DEV_LOG.md`, `AGENT_RECOVERY_MANUAL.md` を更新する。

- [ ] **ドキュメント整備**
    - [ ] **実装:**
        - [ ] `README.md` に、アプリケーションの概要、セットアップ方法、使用技術などを記述する。
    - [ ] **動作確認:**
        - [ ] 記述内容に誤りがないか確認する。
    - [ ] **プロセス記録:**
        - [ ] `DEV_LOG.md`, `AGENT_RECOVERY_MANUAL.md` を更新する。

- [ ] **デプロイ準備**
    - [ ] **実装:**
        - [ ] 本番環境へのデプロイ手順を確立する。
    - [ ] **動作確認:**
        - [ ] デプロイ手順が正しく動作することを確認する。
    - [ ] **プロセス記録:**
        - [ ] `DEV_LOG.md`, `AGENT_RECOVERY_MANUAL.md` を更新する。
